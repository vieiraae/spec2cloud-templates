name: Update Templates Metadata

on:
  push:
    branches:
      - main
    paths:
      - 'templates/**/README.md'
      - 'templates/**/README.MD'

permissions:
  contents: write

jobs:
  update-templates-json:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: Get changed README files
        id: changed-files
        run: |
          # Get list of changed README files in templates directory
          CHANGED_READMES=$(git diff --name-only HEAD^..HEAD | grep -E '^templates/.*/README\.(md|MD)$' || true)
          
          if [ -z "$CHANGED_READMES" ]; then
            echo "No README files changed"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changed README files:"
            echo "$CHANGED_READMES"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            # Save to multiline output
            echo "readme_files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_READMES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
      
      - name: Update templates.json
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          # Process each changed README file on main branch
          while IFS= read -r readme_file; do
            if [ -n "$readme_file" ]; then
              echo "Processing: $readme_file"
              
              # Get last commit date for this specific README file
              last_commit_date=$(git log -1 --format=%ci -- "$readme_file" | head -n1)
              
              if [ -n "$last_commit_date" ]; then
                echo "Last commit date for $readme_file: $last_commit_date"
                export LAST_COMMIT_DATE="$last_commit_date"
              else
                echo "No commit history found for $readme_file"
                unset LAST_COMMIT_DATE
              fi
              
              python .github/workflows/update_templates_json.py "$readme_file"
            fi
          done <<< "${{ steps.changed-files.outputs.readme_files }}"
          
          echo "✅ Generated templates.json on main branch"
      
      - name: Commit templates.json to main branch
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Check if there are changes in templates.json
          if git diff --quiet templates.json; then
            echo "No changes to templates.json on main branch"
          else
            git add templates.json
            git commit -m "chore: update templates.json metadata [skip ci]"
            git push origin main
            echo "✅ Committed templates.json to main branch"
          fi
      
      - name: Copy to pages branch
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          # Check if templates.json was actually updated
          if [ ! -f templates.json ]; then
            echo "Error: templates.json not found"
            exit 1
          fi
          
          # Store templates.json content in a variable
          TEMPLATES_JSON_CONTENT=$(cat templates.json)
          
          # Fetch and checkout pages branch
          git fetch origin pages:pages
          git checkout pages
          
          # Write the content to docs/templates.json
          echo "$TEMPLATES_JSON_CONTENT" > docs/templates.json
          echo "✅ Updated docs/templates.json in pages branch with content from main"
      
      - name: Commit and push changes
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
                    
          # Check if there are changes in docs/templates.json
          if git diff --quiet docs/templates.json; then
            echo "No changes to docs/templates.json"
            git checkout main
          else
            git add docs/templates.json
            git commit -m "chore: update docs/templates.json metadata [skip ci]"
            git push origin pages
            echo "✅ Updated and committed templates.json to pages branch"
            
            # Switch back to main branch
            git checkout main
          fi
